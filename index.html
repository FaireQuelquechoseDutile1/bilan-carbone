<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bilan Carbone Transport</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007acc; color: #fff; cursor: pointer; }
    input { width: 80px; }
    #chartContainer { width: 100%; height: 400px; margin-top: 20px; }
    button, select { padding: 10px 15px; margin-right: 10px; background: #007acc; color: #fff; border: none; cursor: pointer; }
    select { color: #000; }
</style>
</head>
<body>
<h1 id="pageTitle">Bilan Carbone des Déplacements</h1>
<label for="langSelect">Langue :</label>
<select id="langSelect" onchange="updateLanguage()">
    <option value="fr">Français</option>
    <option value="en">English</option>
</select>
<table id="transportTable">
    <thead>
        <tr>
            <th id="thTransport" onclick="sortTable(0)">Moyen de transport</th>
            <th id="thDistance" onclick="sortTable(1)">Distance (km)</th>
            <th id="thEmissions" onclick="sortTable(2)">Émissions CO₂ (kg)</th>
            <th id="thFabrication" onclick="sortTable(3)">Fabrication / Entretien (kg CO₂)</th>
        </tr>
    </thead>
    <tbody>
        <tr><td>Voiture essence</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>500</td></tr>
        <tr><td>Voiture diesel</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>520</td></tr>
        <tr><td>Train</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>50</td></tr>
        <tr><td>Bus</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>40</td></tr>
        <tr><td>Avion</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>150</td></tr>
        <tr><td>Vélo</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>10</td></tr>
        <tr><td>Vélo électrique</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>20</td></tr>
        <tr><td>Trottinette</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>5</td></tr>
        <tr><td>Trottinette électrique</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>15</td></tr>
        <tr><td>Tram</td><td><input type="number" onchange="updateTable()"></td><td>0</td><td>30</td></tr>
    </tbody>
</table>
<p id="totalLabel">Total CO₂ : <span id="totalCO2">0</span> kg</p>
<label for="exportType" id="exportLabel">Type d’export :</label>
<select id="exportType">
    <option value="csv">CSV</option>
    <option value="json">JSON</option>
</select>
<button onclick="exportData()" id="exportBtn">Exporter</button>
<canvas id="chartContainer"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const factors = {
    'Voiture essence': 0.192,
    'Voiture diesel': 0.171,
    'Train': 0.041,
    'Bus': 0.104,
    'Avion': 0.255,
    'Vélo': 0,
    'Vélo électrique': 0.01,
    'Trottinette': 0,
    'Trottinette électrique': 0.01,
    'Tram': 0.03
};

const translations = {
    fr: {
        pageTitle: "Bilan Carbone des Déplacements",
        thTransport: "Moyen de transport",
        thDistance: "Distance (km)",
        thEmissions: "Émissions CO₂ (kg)",
        thFabrication: "Fabrication / Entretien (kg CO₂)",
        totalLabel: "Total CO₂",
        exportLabel: "Type d’export :",
        exportBtn: "Exporter"
    },
    en: {
        pageTitle: "Transport Carbon Footprint",
        thTransport: "Transport method",
        thDistance: "Distance (km)",
        thEmissions: "CO₂ Emissions (kg)",
        thFabrication: "Manufacturing / Maintenance (kg CO₂)",
        totalLabel: "Total CO₂",
        exportLabel: "Export type:",
        exportBtn: "Export"
    }
};

function updateTable() {
    const table = document.getElementById('transportTable').getElementsByTagName('tbody')[0];
    let total = 0;
    for (let row of table.rows) {
        const transport = row.cells[0].innerText;
        const distance = parseFloat(row.cells[1].children[0].value) || 0;
        const emission = factors[transport] !== undefined ? (factors[transport] * distance).toFixed(2) : 'N/A';
        row.cells[2].innerText = emission;
        total += isNaN(emission) ? 0 : parseFloat(emission);
        localStorage.setItem(transport, distance);
    }
    document.getElementById('totalCO2').innerText = total.toFixed(2);
    updateChart();
}

function exportData() {
    const type = document.getElementById('exportType').value;
    const table = document.getElementById('transportTable');
    if (type === 'csv') {
        let csv = [];
        for (let row of table.rows) {
            let rowData = [];
            for (let cell of row.cells) rowData.push(cell.innerText);
            csv.push(rowData.join(','));
        }
        const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'bilan_carbone.csv';
        link.click();
    } else if (type === 'json') {
        const data = [];
        const tbody = table.getElementsByTagName('tbody')[0];
        for (let row of tbody.rows) {
            data.push({
                transport: row.cells[0].innerText,
                distance: row.cells[1].children[0].value || 0,
                emissions: row.cells[2].innerText,
                fabrication: row.cells[3].innerText
            });
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'bilan_carbone.json';
        link.click();
    }
}

function loadLocalStorage() {
    const table = document.getElementById('transportTable').getElementsByTagName('tbody')[0];
    for (let row of table.rows) {
        const transport = row.cells[0].innerText;
        if (localStorage.getItem(transport)) {
            row.cells[1].children[0].value = localStorage.getItem(transport);
        }
    }
    updateTable();
}

function updateChart() {
    const labels = [];
    const data = [];
    const table = document.getElementById('transportTable').getElementsByTagName('tbody')[0];
    for (let row of table.rows) {
        labels.push(row.cells[0].innerText);
        data.push(parseFloat(row.cells[2].innerText) || 0);
    }
    if (window.myChart) window.myChart.destroy();
    const ctx = document.getElementById('chartContainer').getContext('2d');
    window.myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'CO₂ émis (kg)',
                data: data,
                backgroundColor: 'rgba(0, 122, 204, 0.7)'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: true }
            },
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'CO₂ (kg)' } },
                x: { title: { display: true, text: 'Transport' } }
            }
        }
    });
}

function sortTable(n) {
    const table = document.getElementById('transportTable');
    let switching = true;
    let dir = 'asc';
    while (switching) {
        switching = false;
        let rows = table.rows;
        for (let i = 1; i < rows.length - 1; i++) {
            let shouldSwitch = false;
            let x = rows[i].cells[n].innerText;
            let y = rows[i + 1].cells[n].innerText;
            if (!isNaN(parseFloat(x)) && !isNaN(parseFloat(y))) {
                x = parseFloat(x);
                y = parseFloat(y);
            }
            if (dir === 'asc' ? x > y : x < y) {
                shouldSwitch = true;
                break;
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
        } else if (dir === 'asc') {
            dir = 'desc';
            switching = true;
        }
    }
}

function updateLanguage() {
    const lang = document.getElementById('langSelect').value;
    for (let key in translations[lang]) {
        const el = document.getElementById(key);
        if (el) el.innerText = translations[lang][key];
    }
}

window.onload = function() {
    loadLocalStorage();
    updateLanguage();
};
