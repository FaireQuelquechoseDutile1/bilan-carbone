<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bilan Carbone</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; color: #000; transition: 0.3s; }
.dark-mode { background: #121212; color: #ddd; }
.dark-mode table th { background: #333; color: #fff; }
table { border-collapse: collapse; width: 100%; max-width: 800px; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
input[type="number"] { width: 80px; }
button, select { margin: 5px; padding: 5px 10px; }
#chartContainer { max-width: 800px; margin: 20px auto; }
</style>
</head>
<body>

<h1>Bilan Carbone</h1>

<label for="languageSelect">Langue:</label>
<select id="languageSelect" onchange="changeLanguage(this.value)">
  <option value="fr">Français</option>
  <option value="en">English</option>
</select>

<label for="darkSwitch">Dark Mode:</label>
<input type="checkbox" id="darkSwitch" onchange="toggleDarkMode(this.checked)">

<table id="transportTable">
  <thead>
    <tr>
      <th onclick="sortTable(0)">Transport</th>
      <th>Distance (km)</th>
      <th>CO₂ (kg)</th>
      <th>CO₂ fabrication/entretien</th>
    </tr>
  </thead>
  <tbody>
    <tr><td data-key="Voiture essence">Voiture essence</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">500</td></tr>
    <tr><td data-key="Voiture diesel">Voiture diesel</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">520</td></tr>
    <tr><td data-key="Train">Train</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">50</td></tr>
    <tr><td data-key="Bus">Bus</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">40</td></tr>
    <tr><td data-key="Avion">Avion</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">150</td></tr>
    <tr><td data-key="Vélo">Vélo</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">10</td></tr>
    <tr><td data-key="Vélo électrique">Vélo électrique</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">20</td></tr>
    <tr><td data-key="Trottinette">Trottinette</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">5</td></tr>
    <tr><td data-key="Trottinette électrique">Trottinette électrique</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">15</td></tr>
    <tr><td data-key="Tram">Tram</td><td><input type="number" onchange="updateTable()"></td><td class="co2Result">0</td><td class="co2Embodied">30</td></tr>
  </tbody>
  <tfoot>
    <tr>
      <th>Total</th><th></th><th id="totalCO2">0</th><th id="totalEmbodied">0</th>
    </tr>
  </tfoot>
</table>

<button onclick="exportCSV()">Exporter CSV</button>

<div id="chartContainer">
  <canvas id="co2Chart"></canvas>
</div>

<script>
const factors = {
    'Voiture essence': 0.192,
    'Voiture diesel': 0.171,
    'Train': 0.041,
    'Bus': 0.104,
    'Avion': 0.255,
    'Vélo': 0,
    'Vélo électrique': 0.01,
    'Trottinette': 0,
    'Trottinette électrique': 0.01,
    'Tram': 0.03
};

const translations = {
  en: {
    'Voiture essence':'Gasoline car','Voiture diesel':'Diesel car','Train':'Train','Bus':'Bus',
    'Avion':'Plane','Vélo':'Bicycle','Vélo électrique':'Electric bike','Trottinette':'Scooter',
    'Trottinette électrique':'Electric scooter','Tram':'Tram'
  },
  fr: {
    'Voiture essence':'Voiture essence','Voiture diesel':'Voiture diesel','Train':'Train','Bus':'Bus',
    'Avion':'Avion','Vélo':'Vélo','Vélo électrique':'Vélo électrique','Trottinette':'Trottinette',
    'Trottinette électrique':'Trottinette électrique','Tram':'Tram'
  }
};

let currentLang = 'fr';
let darkMode = false;

function updateTable() {
    const table = document.getElementById('transportTable');
    let total = 0;
    let totalEmbodied = 0;
    const chartLabels = [];
    const chartData = [];
    for (let i = 1; i < table.rows.length-1; i++) {
        const row = table.rows[i];
        const key = row.cells[0].getAttribute('data-key');
        const value = parseFloat(row.cells[1].firstChild.value) || 0;
        const co2 = value * factors[key];
        row.cells[2].innerText = co2.toFixed(2);
        total += co2;
        totalEmbodied += parseFloat(row.cells[3].innerText) || 0;
        chartLabels.push(translations[currentLang][key]);
        chartData.push(co2);
        // save in localStorage
        localStorage.setItem('row_'+key, value);
    }
    document.getElementById('totalCO2').innerText = total.toFixed(2);
    document.getElementById('totalEmbodied').innerText = totalEmbodied.toFixed(2);
    updateChart(chartLabels, chartData);
}

function changeLanguage(lang) {
    currentLang = lang;
    const table = document.getElementById('transportTable');
    for (let i = 1; i < table.rows.length-1; i++) {
        const key = table.rows[i].cells[0].getAttribute('data-key');
        table.rows[i].cells[0].innerText = translations[lang][key] || key;
    }
    updateTable();
}

function toggleDarkMode(on) {
    darkMode = on;
    document.body.classList.toggle('dark-mode', on);
}

// CSV export
function exportCSV() {
    const table = document.getElementById('transportTable');
    let csv = '';
    for (let i = 0; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length; j++) {
            row.push(table.rows[i].cells[j].innerText);
        }
        csv += row.join(',') + '\n';
    }
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'bilan_carbone.csv'; a.click();
    URL.revokeObjectURL(url);
}

// Load saved values
function loadSaved() {
    const table = document.getElementById('transportTable');
    for (let i = 1; i < table.rows.length-1; i++) {
        const key = table.rows[i].cells[0].getAttribute('data-key');
        const value = localStorage.getItem('row_'+key);
        if (value) table.rows[i].cells[1].firstChild.value = value;
    }
    updateTable();
}

// Sorting
function sortTable(n) {
    const table = document.getElementById('transportTable');
    let switching = true;
    let dir = 'asc';
    while (switching) {
        switching = false;
        let rows = table.rows;
        for (let i = 1; i < rows.length-2; i++) {
            let x = rows[i].cells[n].innerText.toLowerCase();
            let y = rows[i+1].cells[n].innerText.toLowerCase();
            if (n===0){x=rows[i].cells[n].innerText; y=rows[i+1].cells[n].innerText;}
            let shouldSwitch = false;
            if (dir=="asc" && x>y){shouldSwitch=true; break;}
            if (dir=="desc" && x<y){shouldSwitch=true; break;}
        }
        if (shouldSwitch){
            rows[i].parentNode.insertBefore(rows[i+1], rows[i]);
            switching = true;
        } else if (dir=="asc"){dir="desc"; switching=true;}
    }
    updateTable();
}

// Chart
let chart;
function updateChart(labels, data){
    const ctx = document.getElementById('co2Chart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets:[{ label:'CO₂ (kg)', data, backgroundColor: 'rgba(75,192,192,0.6)' }] },
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
    });
}

window.onload = loadSaved;
</script>
</body>
</html>
