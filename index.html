<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bilan Carbone</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; color: #333; transition: background-color 0.3s, color 0.3s; }
table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { cursor: pointer; background-color: #eaeaea; }
input[type="number"] { width: 80px; }
.controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px; }
.dark-mode { background-color: #1e1e1e; color: #eee; }
.dark-mode th { background-color: #333; }
.dark-mode td, .dark-mode input { background-color: #2a2a2a; color: #eee; border-color: #555; }
button { cursor: pointer; padding: 5px 10px; }
</style>
</head>
<body>
<div class="controls">
    <div>
        <label for="langSelect">Langue:</label>
        <select id="langSelect">
            <option value="fr">Français</option>
            <option value="en">English</option>
        </select>
        <label for="darkSwitch">Dark Mode:</label>
        <input type="checkbox" id="darkSwitch">
    </div>
    <div>
        <button id="exportCSVBtn">Exporter CSV</button>
        <button id="exportJSONBtn">Exporter JSON</button>
    </div>
</div>

<table id="transportTable">
    <thead>
        <tr>
            <th id="thTransport">Transport</th>
            <th id="thDistance">Distance (km)</th>
            <th id="thCO2">CO₂ Transport (kg)</th>
            <th id="thEmbodied">CO₂ Fabrication/Entretien (kg)</th>
        </tr>
    </thead>
    <tbody>
        <tr><td>Voiture essence</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">5</td></tr>
        <tr><td>Voiture diesel</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">5</td></tr>
        <tr><td>Bus</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">3</td></tr>
        <tr><td>Train</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">2</td></tr>
        <tr><td>Avion court courrier</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">50</td></tr>
        <tr><td>Avion long courrier</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">150</td></tr>
        <tr><td>Bicyclette</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">2</td></tr>
        <tr><td>Vélo électrique</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">5</td></tr>
        <tr><td>Trotinette</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">1</td></tr>
        <tr><td>Trotinette électrique</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">3</td></tr>
        <tr><td>Tram</td><td><input type="number" min="0" oninput="calculateRow(this)"></td><td class="co2Result">0</td><td class="co2Embodied">1</td></tr>
    </tbody>
    <tfoot>
        <tr>
            <td colspan="2"><strong>Total CO₂ (kg)</strong></td>
            <td id="totalCO2">0</td>
            <td id="totalEmbodied">0</td>
        </tr>
    </tfoot>
</table>

<canvas id="chartContainer" height="200"></canvas>

<script>
const factors = {
    'Voiture essence': 0.192,
    'Voiture diesel': 0.171,
    'Bus': 0.105,
    'Train': 0.041,
    'Avion court courrier': 0.285,
    'Avion long courrier': 0.195,
    'Bicyclette': 0,
    'Vélo électrique': 0.05,
    'Trotinette': 0.02,
    'Trotinette électrique': 0.03,
    'Tram': 0.04
};

const translations = {
    fr: {
        thTransport: 'Transport', thDistance: 'Distance (km)', thCO2: 'CO₂ Transport (kg)', thEmbodied: 'CO₂ Fabrication/Entretien (kg)',
        exportCSVBtn: 'Exporter CSV', exportJSONBtn: 'Exporter JSON'
    },
    en: {
        thTransport: 'Transport', thDistance: 'Distance (km)', thCO2: 'CO₂ Transport (kg)', thEmbodied: 'CO₂ Manufacture/Maintenance (kg)',
        exportCSVBtn: 'Export CSV', exportJSONBtn: 'Export JSON'
    }
};

function calculateRow(input) {
    const row = input.parentElement.parentElement;
    const transport = row.cells[0].innerText;
    const distance = parseFloat(input.value) || 0;
    const co2 = distance * (factors[transport] || 0);
    row.querySelector('.co2Result').innerText = co2.toFixed(2);
    updateTotals();
    updateChart();
    saveLocalStorage();
}

function updateTotals() {
    let totalCo2 = 0, totalEmbodied = 0;
    document.querySelectorAll('#transportTable tbody tr').forEach(row => {
        totalCo2 += parseFloat(row.querySelector('.co2Result').innerText) || 0;
        totalEmbodied += parseFloat(row.querySelector('.co2Embodied').innerText) || 0;
    });
    document.getElementById('totalCO2').innerText = totalCo2.toFixed(2);
    document.getElementById('totalEmbodied').innerText = totalEmbodied.toFixed(2);
}

function saveLocalStorage() {
    const distances = Array.from(document.querySelectorAll('#transportTable tbody tr input[type="number"]:not([step])')).map(i => i.value);
    const factorValues = Array.from(document.querySelectorAll('#transportTable tbody tr input[type="number"][step]')).map(i => i.value);
    localStorage.setItem('distances', JSON.stringify(distances));
    localStorage.setItem('factors', JSON.stringify(factorValues));
}

function loadLocalStorage() {
    const distances = JSON.parse(localStorage.getItem('distances') || '[]');
    const factorValues = JSON.parse(localStorage.getItem('factors') || '[]');
    document.querySelectorAll('#transportTable tbody tr').forEach((row,i) => {
        const distanceInput = row.querySelector('input[type="number"]:not([step])');
        const factorInput = row.querySelector('input[type="number"][step]');
        if(distances[i] !== undefined) distanceInput.value = distances[i];
        if(factorValues[i] !== undefined) {
            factorInput.value = factorValues[i];
            factors[row.cells[0].innerText] = parseFloat(factorValues[i]) || 0;
        }
        calculateRow(distanceInput);
    });
}

function exportCSV() {
    let csv = 'Transport,Distance,CO2,CO2 Fabrication/Entretien\\n';
    document.querySelectorAll('#transportTable tbody tr').forEach(row => {
        csv += [
            row.cells[0].innerText,
            row.querySelector('input').value,
            row.querySelector('.co2Result').innerText,
            row.querySelector('.co2Embodied').innerText
        ].join(',') + '\\n';
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bilan_carbone.csv';
    a.click();
}

function exportJSON() {
    const data = Array.from(document.querySelectorAll('#transportTable tbody tr')).map(row => ({
        transport: row.cells[0].innerText,
        distance: row.querySelector('input').value,
        co2: row.querySelector('.co2Result').innerText,
        co2Embodied: row.querySelector('.co2Embodied').innerText
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'bilan_carbone.json';
    a.click();
}

document.getElementById('exportCSVBtn').onclick = exportCSV;
document.getElementById('exportJSONBtn').onclick = exportJSON;

document.getElementById('langSelect').onchange = function() {
    const lang = this.value;
    Object.keys(translations[lang]).forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerText = translations[lang][id];
    });
}

document.getElementById('darkSwitch').onchange = function() {
    document.body.classList.toggle('dark-mode', this.checked);
    localStorage.setItem('darkMode', this.checked);
}

function initDarkMode() {
    const dark = localStorage.getItem('darkMode') === 'true';
    document.getElementById('darkSwitch').checked = dark;
    document.body.classList.toggle('dark-mode', dark);
}

// Chart
let chart;
function updateChart() {
    const labels = Array.from(document.querySelectorAll('#transportTable tbody tr td:first-child')).map(td => td.innerText);
    const data = Array.from(document.querySelectorAll('#transportTable tbody tr .co2Result')).map(td => parseFloat(td.innerText) || 0);
    if(chart) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    } else {
        const ctx = document.getElementById('chartContainer').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'CO₂ Transport (kg)', data, backgroundColor: '#4caf50' }] },
            options: { responsive: true, scales: { y: { beginAtZero:true } } }
        });
    }
}

// Initialisation
loadLocalStorage();
initDarkMode();
updateChart();
</script>
</body>
</html>
